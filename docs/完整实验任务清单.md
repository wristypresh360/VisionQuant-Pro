# VisionQuant-Pro 完整实验任务清单

## 📊 当前状态

- ✅ **索引重建**：已启动（后台运行，预计 1-2 小时）
  - 进度：约 10%（4万/40万张）
  - 检查进度：`tail -f logs/rebuild_index.log`
- ✅ **模型切换**：已切换到 AttentionCAE
- ⏳ **待执行**：以下所有实验

---

## 🎯 任务清单（按优先级排序）

### 阶段 1: 索引重建与验证（当前进行中）

#### ✅ 1.1 索引重建
- **状态**：✅ 已启动（后台运行）
- **命令**：`python3 scripts/rebuild_index_attention.py`
- **预计时间**：1-2 小时（Mac MPS GPU）
- **输出文件**：
  - `data/indices/cae_faiss_attention.bin` (新索引)
  - `data/indices/meta_data_attention.csv` (新元数据)
- **验证方法**：
  ```bash
  # 检查进度
  tail -f logs/rebuild_index.log
  
  # 检查文件是否生成
  ls -lh data/indices/cae_faiss_attention.bin
  ```

#### ⏳ 1.2 索引验证
- **任务**：验证新索引是否正常工作
- **步骤**：
  1. 重启 Streamlit 应用
  2. 测试几只股票（如 300537, 600519, 000001）
  3. 检查对比图是否正常显示 Top 10
  4. 对比新旧索引的相似度分数（新索引应该更高）
- **验证脚本**：
  ```python
  from src.models.vision_engine import VisionEngine
  v = VisionEngine()
  v.reload_index()
  # 测试检索
  matches = v.search_similar_patterns("test.png", top_k=10)
  print(f"找到 {len(matches)} 个匹配")
  ```

---

### 阶段 2: 回测实验（防止未来函数）

#### ⏳ 2.1 回测框架验证
- **文件**：`src/strategies/backtester.py`
- **关键点**：确保没有未来函数
- **检查项**：
  - ✅ **时间隔离**：查询日期 T 只能使用 T-20 天之前的数据
  - ✅ **预加载数据**：回测开始前预加载 300 天历史数据
  - ✅ **严格时间切片**：`mask = (df.index >= start_date) & (df.index <= end_date)`
  - ✅ **不重叠**：相似模式必须来自历史，不能来自未来

#### ⏳ 2.2 单股票回测
- **任务**：对 50 只股票进行回测
- **股票池**：从 A 股中选取 50 只（覆盖不同行业、市值）
- **时间范围**：2022-01-01 至 2025-01-01（3 年）
- **指标计算**：
  - 策略收益率
  - 基准收益率（买入持有）
  - Alpha（超额收益）
  - 最大回撤
  - 夏普比率
  - 交易次数
- **输出**：CSV 文件，包含每只股票的详细回测结果

#### ⏳ 2.3 组合回测
- **任务**：测试组合优化策略
- **方法**：Markowitz 均值方差优化
- **参数**：
  - 最大持仓数：10
  - 最小仓位：5%
  - 最大仓位：20%
- **输出**：组合收益曲线、权重分配、风险指标

---

### 阶段 3: 基线对比实验

#### ⏳ 3.1 运行基线实验
- **文件**：`src/strategies/baseline_experiments.py`
- **基线策略**（5 种）：
  1. **Buy-and-Hold**：买入持有
  2. **MA Crossover**：均线交叉（MA20/MA60）
  3. **RSI**：相对强弱指标（RSI < 30 买入，RSI > 70 卖出）
  4. **MACD**：MACD 金叉买入，死叉卖出
  5. **Momentum**：动量策略（过去 20 天收益率 > 阈值买入）
- **任务**：
  - 对同一股票池运行所有基线策略
  - 计算相同的性能指标
  - 生成对比表格

#### ⏳ 3.2 统计显著性测试
- **测试方法**：
  1. **配对 t 检验**：检验 VisionQuant 与每个基线的收益差异是否显著
  2. **Wilcoxon 符号秩检验**：非参数检验（不假设正态分布）
  3. **Cohen's d**：效应量（衡量差异的实际意义）
- **输出**：
  - LaTeX 表格（用于论文）
  - 统计测试结果 CSV

---

### 阶段 4: 消融实验

#### ⏳ 4.1 运行消融实验
- **文件**：`src/strategies/ablation_study.py`
- **实验配置**（9 种）：
  1. **Full Model**：完整模型（AttentionCAE + 相关性 + 时间隔离）
  2. **w/o Attention**：移除 Attention 模块
  3. **w/o Correlation**：移除价格相关性
  4. **w/o Time Isolation**：移除时间隔离（NMS）
  5. **ResNet Features**：用 ResNet 特征替代 CAE
  6. **4 Heads**：Attention 头数 = 4
  7. **16 Heads**：Attention 头数 = 16
  8. **Latent 512**：隐空间维度 = 512
  9. **Latent 2048**：隐空间维度 = 2048
- **任务**：
  - 对每个配置运行回测
  - 计算性能指标
  - 生成消融表格

#### ⏳ 4.2 消融结果分析
- **分析内容**：
  - 每个组件的贡献度
  - Attention 模块的增益（预期 +2.5% Alpha）
  - 相关性融合的增益
  - 时间隔离的必要性
- **输出**：消融实验报告（Markdown + LaTeX 表格）

---

### 阶段 5: 论文数据填充

#### ⏳ 5.1 更新论文中的实验数据
- **文件**：`paper/visionquant_arxiv.tex`
- **需要更新的部分**：
  1. **Abstract**：更新 Alpha、Sharpe 比率等关键指标
  2. **Results Section**：
     - 表 1：50 只股票的回测结果汇总
     - 表 2：与基线策略的对比（含统计测试）
     - 表 3：消融实验结果
  3. **Figures**：
     - 回测收益曲线图
     - Attention 权重可视化
     - 消融实验对比图

#### ⏳ 5.2 生成 LaTeX 表格
- **工具**：`baseline_experiments.py` 和 `ablation_study.py` 会自动生成
- **输出位置**：`paper/tables/`
- **表格类型**：
  - `baseline_comparison.tex`
  - `ablation_results.tex`
  - `statistical_tests.tex`

---

### 阶段 6: 可视化与解释性

#### ⏳ 6.1 Attention 权重可视化
- **文件**：`src/utils/attention_visualizer.py`
- **任务**：
  - 选择几个典型 K 线形态（头肩顶、双底等）
  - 可视化 Attention 权重热力图
  - 说明模型关注哪些区域
- **输出**：PNG 图片（用于论文）

#### ⏳ 6.2 相似模式案例分析
- **任务**：
  - 选择几个成功案例（高 Alpha 的股票）
  - 展示查询模式与匹配模式的对比
  - 分析为什么匹配成功
- **输出**：案例报告（Markdown）

---

### 阶段 7: 性能优化与验证

#### ⏳ 7.1 检索速度测试
- **任务**：
  - 测试单次检索时间（目标 < 100ms）
  - 测试批量检索时间（100 只股票）
  - 对比新旧索引的检索速度
- **输出**：性能报告

#### ⏳ 7.2 内存占用测试
- **任务**：
  - 测试模型加载后的内存占用
  - 测试索引加载后的内存占用
  - 优化建议
- **输出**：内存使用报告

---

## 🔒 防止未来函数的关键检查点

### ✅ 已实现的保护机制

1. **时间隔离（NMS）**：
   ```python
   ISOLATION_DAYS = 20  # 查询日期 T 只能使用 T-20 天之前的数据
   ```

2. **严格时间切片**：
   ```python
   mask = (df.index >= start_date) & (df.index <= end_date)
   df_bt = df.loc[mask].copy()
   ```

3. **预加载历史数据**：
   ```python
   preload_date = (start_dt - timedelta(days=300)).strftime("%Y%m%d")
   df_raw = self.loader.get_stock_data(symbol, start_date=preload_date)
   ```

4. **相似模式时间检查**：
   ```python
   if abs((current_dt - existing_dt).days) < ISOLATION_DAYS:
       continue  # 跳过时间冲突的模式
   ```

### ⚠️ 需要验证的点

1. **回测循环中的时间顺序**：
   - 确保按时间顺序遍历（不能跳跃）
   - 确保每个交易日只使用之前的数据

2. **相似模式检索的时间约束**：
   - 确保检索时只考虑历史模式
   - 确保匹配模式的日期 < 查询日期 - 20 天

3. **技术指标计算**：
   - MA60、RSI、MACD 等必须只用历史数据计算
   - 不能使用未来数据

---

## 📋 执行顺序建议

### 立即执行（索引重建期间）

1. ✅ **索引重建**（已启动，等待完成）
2. ⏳ **准备实验脚本**（检查并修复 bug）
3. ⏳ **准备股票池**（50 只股票列表）

### 索引重建完成后

1. **验证新索引**（30 分钟）
2. **运行单股票回测**（2-3 小时，50 只股票）
3. **运行基线实验**（1-2 小时）
4. **运行消融实验**（3-4 小时，9 种配置）
5. **统计显著性测试**（30 分钟）
6. **生成 LaTeX 表格**（自动）
7. **更新论文数据**（1-2 小时）
8. **可视化生成**（1 小时）

---

## 🛠️ 工具和脚本

### 已存在的脚本

1. **`scripts/rebuild_index_attention.py`**：索引重建
2. **`src/strategies/baseline_experiments.py`**：基线实验
3. **`src/strategies/ablation_study.py`**：消融实验
4. **`src/strategies/backtester.py`**：回测框架
5. **`src/utils/attention_visualizer.py`**：Attention 可视化

### 需要创建的脚本

1. **`scripts/run_all_experiments.py`**：一键运行所有实验
2. **`scripts/validate_backtest.py`**：验证回测没有未来函数
3. **`scripts/generate_paper_tables.py`**：生成所有论文表格

---

## 📊 预期结果

### 性能指标目标

- **Alpha**：> 10%（相比买入持有）
- **Sharpe 比率**：> 1.5
- **最大回撤**：< 30%
- **胜率**：> 55%

### 统计显著性目标

- **配对 t 检验**：p < 0.001（高度显著）
- **Cohen's d**：> 0.5（中等效应量）

### 消融实验预期

- **Attention 模块增益**：+2.5% Alpha
- **相关性融合增益**：+1.5% Alpha
- **时间隔离必要性**：防止未来函数，提升稳健性

---

## ⚠️ 注意事项

1. **数据一致性**：确保所有实验使用相同的数据集
2. **随机种子**：设置固定随机种子，确保可复现
3. **计算资源**：某些实验可能需要较长时间，建议后台运行
4. **结果备份**：定期备份实验结果，避免丢失
5. **版本控制**：记录每次实验的代码版本和参数

---

## 📝 更新日志

- **2026-01-13**：创建任务清单
- **2026-01-13**：索引重建已启动

---

## 🎯 下一步行动

1. **等待索引重建完成**（检查 `logs/rebuild_index.log`）
2. **验证新索引**（重启 Streamlit，测试检索）
3. **开始回测实验**（运行 `backtester.py`）
4. **运行基线实验**（运行 `baseline_experiments.py`）
5. **运行消融实验**（运行 `ablation_study.py`）
